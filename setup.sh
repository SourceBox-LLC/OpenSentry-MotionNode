#!/bin/bash
# OpenSentry Camera Node - Quick Setup Script
# Run: chmod +x setup.sh && ./setup.sh

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘           OpenSentry Camera Node - Quick Setup                â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check for Docker
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker not found. Please install Docker first:"
    echo "   curl -fsSL https://get.docker.com | sh"
    exit 1
fi

echo "âœ… Docker found"

# Check for camera
echo ""
echo "ðŸŽ¥ Detecting cameras..."
cameras=$(ls /dev/video* 2>/dev/null || true)
if [ -z "$cameras" ]; then
    echo "âŒ No cameras found. Please connect a USB webcam."
    exit 1
fi

echo "   Found: $cameras"
default_cam=$(echo "$cameras" | head -n1)

# Check if .env exists
if [ -f .env ]; then
    echo ""
    echo "âœ… .env file already exists"
    read -p "   Overwrite with new settings? (y/N): " overwrite
    if [ "$overwrite" != "y" ] && [ "$overwrite" != "Y" ]; then
        echo "   Keeping existing .env"
        echo ""
        echo "ðŸš€ Starting Camera Node..."
        docker compose up --build -d
        echo ""
        echo "âœ… Camera Node is running!"
        echo "   Logs: docker compose logs -f"
        exit 0
    fi
fi

echo ""
echo "ðŸ“ Let's configure your Camera Node..."
echo ""

# Get camera name
hostname=$(hostname)
read -p "Camera name [${hostname}]: " camera_name
camera_name=${camera_name:-$hostname}

# Get camera device
read -p "Camera device [${default_cam}]: " camera_device
camera_device=${camera_device:-$default_cam}

# Get secret
echo ""
echo "ðŸ” Enter the OPENSENTRY_SECRET from your Command Center."
echo "   (Run 'cat .env' on the Command Center to find it)"
echo ""
read -p "OPENSENTRY_SECRET: " secret

if [ -z "$secret" ]; then
    echo "âš ï¸  No secret entered. Camera will use default credentials."
    echo "   This is less secure but will still work on trusted networks."
fi

# Create .env file
cat > .env << EOF
# OpenSentry Camera Node Configuration
# Generated by setup.sh on $(date)

# Camera identification
CAMERA_NAME=$camera_name
CAMERA_DEVICE=$camera_device

# Security secret (must match Command Center!)
OPENSENTRY_SECRET=$secret
EOF

echo ""
echo "âœ… Configuration saved to .env"

# Start the service
echo ""
echo "ðŸš€ Building and starting Camera Node (this may take a few minutes)..."
docker compose up --build -d

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                    Setup Complete!                            â•‘"
echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo "â•‘  Camera Name:  $camera_name"
echo "â•‘  Device:       $camera_device"
echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo "â•‘  Your camera should appear in the Command Center              â•‘"
echo "â•‘  dashboard within 30 seconds.                                 â•‘"
echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo "â•‘  Commands:                                                    â•‘"
echo "â•‘    View logs:    docker compose logs -f                       â•‘"
echo "â•‘    Stop:         docker compose down                          â•‘"
echo "â•‘    Restart:      docker compose restart                       â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
